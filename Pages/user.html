<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="../style.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><img src="../image.png" alt="CareerConnect Logo" class="navbar-logo"></div>
        <ul class="nav-links">
            <li><a href="../index.html">Home</a></li>
            <li><a href="internship_listing.html">Internships</a></li>
            <li><a href="#" id="user-dashboard-link" style="display: none;">Dashboard</a></li>
            <li><a href="#" id="login-logout-link">Login</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1>User Dashboard</h1>

        <div class="dashboard-section">
            <h2>Applied Internships</h2>
            <table id="applied-internships-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Applied internships will be loaded here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const loginLogoutLink = document.getElementById('login-logout-link');
        const userDashboardLink = document.getElementById('user-dashboard-link');

        let currentUser = null;

        // Function to handle logout
        function handleLogout() {
            auth.signOut().then(() => {
                // Redirect to login page after logout
                window.location.href = 'login.html';
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        }

        // Check authentication state and update login/logout link and dashboard link
        auth.onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in
                currentUser = user;
                loginLogoutLink.textContent = 'Logout';
                loginLogoutLink.href = '#'; // Prevent default link behavior
                loginLogoutLink.removeEventListener('click', handleLogout);
                loginLogoutLink.addEventListener('click', handleLogout);

                // Show user dashboard link
                userDashboardLink.style.display = 'block';
                userDashboardLink.href = 'user.html';

                // Fetch and display applications
                fetchAppliedJobs();
                fetchAppliedInternships();

            } else {
                // User is signed out
                currentUser = null;
                loginLogoutLink.textContent = 'Login';
                loginLogoutLink.href = 'login.html'; // Link to login page
                loginLogoutLink.removeEventListener('click', handleLogout);

                // Hide user dashboard link
                userDashboardLink.style.display = 'none';

                // Clear tables if user logs out
                document.getElementById('applied-jobs-table').querySelector('tbody').innerHTML = '';
                document.getElementById('applied-internships-table').querySelector('tbody').innerHTML = '';

                // Redirect to login page if on user.html
                if (window.location.pathname.includes('user.html')) {
                    window.location.href = 'login.html';
                }
            }
        });

        // Function to fetch and display applied jobs
        async function fetchAppliedJobs() {
            if (!currentUser) return;
            const appliedJobsTableBody = document.getElementById('applied-jobs-table').querySelector('tbody');
            appliedJobsTableBody.innerHTML = ''; // Clear existing rows

            try {
                const jobApplicationsRef = db.collection('jobApplications');
                const querySnapshot = await jobApplicationsRef
                    .where('userId', '==', currentUser.uid)
                    .get();

                querySnapshot.forEach((doc) => {
                    const application = doc.data();
                    const row = appliedJobsTableBody.insertRow();
                    row.insertCell(0).textContent = application.title || 'N/A';
                    row.insertCell(1).textContent = application.status || 'Pending';
                    const actionsCell = row.insertCell(2);
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.onclick = () => editApplication('job', doc.id, application.title);
                    actionsCell.appendChild(editButton);
                });
            } catch (error) {
                console.error('Error fetching applied jobs:', error);
                // Display an error message in the table or feedback area
            }
        }

        // Function to fetch and display applied internships
        async function fetchAppliedInternships() {
            if (!currentUser) return;
            const appliedInternshipsTableBody = document.getElementById('applied-internships-table').querySelector('tbody');
            appliedInternshipsTableBody.innerHTML = ''; // Clear existing rows

            try {
                const internshipApplicationsRef = db.collection('internshipApplications');
                const querySnapshot = await internshipApplicationsRef
                    .where('userId', '==', currentUser.uid)
                    .get();

                querySnapshot.forEach((doc) => {
                    const application = doc.data();
                    const row = appliedInternshipsTableBody.insertRow();
                    row.insertCell(0).textContent = application.title || 'N/A';
                    row.insertCell(1).textContent = application.status || 'Pending';
                    const actionsCell = row.insertCell(2);
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                     editButton.onclick = () => editApplication('internship', doc.id, application.title);
                    actionsCell.appendChild(editButton);
                });
            } catch (error) {
                console.error('Error fetching applied internships:', error);
                // Display an error message in the table or feedback area
            }
        }

        // Function to handle editing application
        function editApplication(type, applicationId, title) {
            if (type === 'job') {
                window.location.href = `job_registration.html?id=${applicationId}&title=${encodeURIComponent(title)}`;
            } else if (type === 'internship') {
                window.location.href = `internship_registration.html?id=${applicationId}&title=${encodeURIComponent(title)}`;
            }
        }

        // Initial fetch if user is already logged in on page load
         if (auth.currentUser) {
             currentUser = auth.currentUser;
             userDashboardLink.style.display = 'block';
             userDashboardLink.href = 'user.html';
             fetchAppliedJobs();
             fetchAppliedInternships();
         }
    </script>
</body>
</html>