<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Generator</title>
    
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.10.11/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #4a5568;
            --secondary-color: #f7fafc;
            --text-color: #2d3748;
            --bg-color: #edf2f7;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .preview-area {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: visible;
            border: 1px solid var(--border-color);
            background-color: white;
        }
        .preview-area::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: #f0f0f0;
            z-index: -1;
            border-radius: 4px;
        }
        .preview-area::after {
            content: attr(data-paper-size);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .draggable {
            touch-action: none;
            user-select: none;
            position: absolute !important;
            box-sizing: border-box;
            border: 2px dashed transparent;
            transition: border-color 0.2s;
            padding: 5px;
            cursor: move;
            min-width: 50px;
            min-height: 20px;
        }
        .draggable.selected {
            border: 2px dashed #4a5568;
            resize: both;
            overflow: auto;
        }
        .draggable:hover {
            border: 2px dashed #718096;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #4a5568;
            border: 1px solid white;
        }
        .resize-handle.top-left { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.top-right { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.bottom-left { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.bottom-right { bottom: -5px; right: -5px; cursor: se-resize; }

        .draggable.selected {
            border-color: var(--primary-color);
            z-index: 1000;
        }

        .tab-btn {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #718096;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: #fff;
            transition: all 0.3s ease;
            font-size: 14px;
            color: var(--text-color);
        }

        .form-input:hover, .form-select:hover {
            border-color: #cbd5e0;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.15);
        }

        .form-input::placeholder {
            color: #a0aec0;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }
        
        .btn {
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(74, 85, 104, 0.2);
        }

        .btn-primary:hover {
            background-color: #2d3748;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(74, 85, 104, 0.2);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(74, 85, 104, 0.2);
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary-color);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
            background-color: #f8fafc;
        }

        .orientation-btn {
            padding: 8px 16px;
            flex: 1;
            background-color: white;
            border: 2px solid var(--border-color);
            color: var(--text-color);
        }

        .orientation-btn:first-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .orientation-btn:last-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .orientation-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .align-btn {
            padding: 8px;
            background-color: white;
            border: 2px solid var(--border-color);
            color: var(--text-color);
        }

        .align-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .align-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .controls-panel {
            background: white; 
            padding: 2rem; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .panel-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .space-y-4 > *:not(:last-child) {
            margin-bottom: 1.5rem;
        }

        .section-divider {
            height: 1px;
            background: var(--border-color);
            margin: 2rem 0;
        }

        .hidden {
            display: none;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            background: #e2e8f0;
            color: var(--text-color);
        }

        .badge-primary {
            background: var(--primary-color);
            color: white;
        }

        .preview-container {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 2rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><img src="../image1.png" alt="CareerConnect Logo" class="navbar-logo"></div>
        <ul class="nav-links">
            <li><a href="admin_panel.html">Admin Home</a></li>
        </ul>
    </nav>

    <div class="container" style="max-width: 1400px; margin: auto; padding: 2rem;">
        <main style="display: grid; grid-template-columns: 400px 1fr; gap: 2rem;">
            <div class="controls-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Certificate Generator</h2>
                </div>
                
                <div class="tabs" style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <button class="btn btn-secondary active" data-tab="content" style="flex: 1">
                        <i class="fas fa-pen-to-square"></i>
                        Content
                    </button>
                    <button class="btn btn-secondary" data-tab="customize" style="flex: 1">
                        <i class="fas fa-palette"></i>
                        Design
                    </button>
                    <button class="btn btn-secondary" data-tab="batch" style="flex: 1">
                        <i class="fas fa-layer-group"></i>
                        Batch
                    </button>
                </div>

                <div id="tab-panels">
                    <div id="tab-content" class="space-y-4">
                        <h3 style="font-size: 1.25rem; font-weight: 600;">Certificate Content</h3>
                        
                        <!-- Default Elements -->
                        <div class="default-elements">
                            <h4 style="font-size: 1rem; font-weight: 500; margin-bottom: 1rem;">Required Fields</h4>
                            <div>
                                <label for="field-certificateTitle" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Certificate Title</label>
                                <input type="text" id="field-certificateTitle" data-field="certificateTitle" class="form-input" 
                                    value="Internship Completion Certificate">
                            </div>
                            <div class="mt-3">
                                <label for="field-recipientName" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Recipient's Name</label>
                                <input type="text" id="field-recipientName" data-field="recipientName" class="form-input" 
                                    value="Jane Doe">
                            </div>
                            <div class="mt-3">
                                <label for="field-completionText" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Achievement Statement</label>
                                <textarea id="field-completionText" data-field="completionText" class="form-input" style="min-height: 60px;"
                                    >This is to certify that the above named individual has successfully completed</textarea>
                            </div>
                            <div class="mt-3">
                                <label for="field-courseName" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Program/Course Title</label>
                                <textarea id="field-courseName" data-field="courseName" class="form-input" style="min-height: 60px;"
                                    >a comprehensive internship program in Web Development, demonstrating exceptional skills and dedication throughout the duration of the program</textarea>
                            </div>
                            <div class="mt-3">
                                <label for="field-date" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Date of Issue</label>
                                <input type="date" id="field-date" data-field="date" class="form-input">
                            </div>
                            <div class="mt-3">
                                <label for="field-signatureTitle" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Signatory Title</label>
                                <input type="text" id="field-signatureTitle" data-field="signatureTitle" class="form-input" 
                                    value="Program Director">
                            </div>
                        </div>

                        <!-- Custom Text Boxes -->
                        <div class="custom-elements mt-6">
                            <h4 style="font-size: 1rem; font-weight: 500; margin-bottom: 1rem;">Additional Text Boxes</h4>
                            <div id="custom-text-boxes">
                                <!-- Custom text boxes will be added here -->
                            </div>
                            <button id="add-text-box" class="btn" style="margin-top: 1rem; border: 1px dashed var(--border-color); width: 100%; background: transparent; color: var(--primary-color);">
                                <i class="fas fa-plus" style="margin-right: 0.5rem;"></i>
                                Add Text Box
                            </button>
                        </div>

                        <!-- Template and Paper Size Selectors -->
                        <div class="mt-6" style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                            <h4 style="font-size: 1rem; font-weight: 500; margin-bottom: 1rem;">Certificate Settings</h4>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem;">Template Style</label>
                                <select id="template-selector" class="form-select">
                                    <option value="internship">Internship Certificate</option>
                                    <option value="achievement">Achievement Award</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">Paper Size</label>
                                <select id="paper-size" class="form-select">
                                    <option value="a4">A4 (210 × 297 mm)</option>
                                    <option value="a3">A3 (297 × 420 mm)</option>
                                    <option value="letter">US Letter (216 × 279 mm)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="tab-customize" class="hidden space-y-4">
                        <h3 style="font-size: 1.25rem; font-weight: 600;">Layout & Style</h3>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Orientation</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <button id="orientation-landscape" class="orientation-btn btn active">Landscape</button>
                                <button id="orientation-portrait" class="orientation-btn btn">Portrait</button>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Background Image</label>
                            <input type="file" id="bg-image" accept="image/*" class="form-input">
                        </div>
                        <div id="element-styler" class="hidden" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                            <h4 id="styler-label" style="font-weight: 600; margin-bottom: 1rem;"></h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label>Font Size (px)</label>
                                    <input type="number" id="styler-fontSize" class="form-input">
                                </div>
                                <div>
                                    <label>Font Family</label>
                                    <select id="styler-fontFamily" class="form-select">
                                        <option value="'Playfair Display', serif">Serif</option>
                                        <option value="'Inter', sans-serif">Sans-serif</option>
                                        <option value="'Roboto Mono', monospace">Monospace</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Color</label>
                                    <input type="color" id="styler-color" class="form-input" style="padding: 5px;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="styler-fontWeight" style="width: 20px; height: 20px;">
                                    <label>Bold</label>
                                </div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem;">Alignment</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="align-btn btn" data-align="left"><i class="fas fa-align-left"></i></button>
                                    <button class="align-btn btn" data-align="center"><i class="fas fa-align-center"></i></button>
                                    <button class="align-btn btn" data-align="right"><i class="fas fa-align-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-batch" class="hidden space-y-4">
                        <h3 style="font-size: 1.25rem; font-weight: 600;">Batch Certificate Generation</h3>
                        <p style="font-size: 0.9rem; color: #718096;">
                            Upload an Excel (.xlsx) file. The system will read the columns and allow you to map them to the certificate fields.
                        </p>
                        <input type="file" id="excel-file" accept=".xlsx" class="form-input">
                        
                        <div id="column-mapping" class="hidden space-y-4" style="margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                            <h4 style="font-weight: 600;">Map Excel Columns to Certificate Fields</h4>
                            <div>
                                <label for="map-recipientName" style="display: block; margin-bottom: 0.5rem;">Recipient's Name</label>
                                <select id="map-recipientName" data-field="recipientName" class="form-select column-map-select"></select>
                            </div>
                            <div>
                                <label for="map-courseName" style="display: block; margin-bottom: 0.5rem;">Course/Internship Title</label>
                                <select id="map-courseName" data-field="courseName" class="form-select column-map-select"></select>
                            </div>
                            <div>
                                <label for="map-date" style="display: block; margin-bottom: 0.5rem;">Date Column (Optional)</label>
                                <select id="map-date" data-field="date" class="form-select column-map-select">
                                    <option value="">-- No Date Column --</option>
                                </select>
                            </div>
                            <div style="margin-top: 1rem;">
                                <label for="batch-issue-date" style="display: block; margin-bottom: 0.5rem;">
                                    <input type="checkbox" id="use-custom-date" style="margin-right: 0.5rem;">
                                    Use Custom Issue Date
                                </label>
                                <div id="custom-date-input" class="hidden">
                                    <input type="date" id="batch-issue-date" class="form-input" value="2025-08-31">
                                    <p style="font-size: 0.875rem; color: #718096; margin-top: 0.5rem;">
                                        This date will be used for all certificates that don't have a date in the Excel file.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <button id="batch-generate-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;" disabled>
                            <span id="batch-btn-text">Generate Certificates</span>
                            <div id="batch-loader" class="loader hidden" style="margin-left: 10px;"></div>
                        </button>
                        <div id="batch-progress" class="hidden" style="margin-top: 1rem;">
                            <p id="progress-text" style="text-align: center; margin-bottom: 0.5rem;"></p>
                            <div style="width: 100%; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                                <div id="progress-bar" style="width: 0%; height: 10px; background: var(--primary-color); transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-divider"></div>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button id="generate-pdf-btn" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-file-pdf"></i>
                        Generate Certificate
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.reload()">
                        <i class="fas fa-rotate"></i>
                        Reset
                    </button>
                </div>
            </div>

            <div id="preview-container" style="background: var(--secondary-color); padding: 2rem; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <div id="preview-area" class="preview-area">
                    <div id="el-certificateTitle" data-id="certificateTitle" class="draggable">Certificate of Completion</div>
                    <div id="el-completionText" data-id="completionText" class="draggable">has successfully completed</div>
                    <div id="el-recipientName" data-id="recipientName" class="draggable">Jane Doe</div>
                    <div id="el-courseName" data-id="courseName" class="draggable">Web Development Masterclass</div>
                    <div id="el-date" data-id="date" class="draggable">July 28, 2025</div>
                    <div id="el-signature" data-id="signature" class="draggable">_________________________</div>
                    <div id="el-signatureTitle" data-id="signatureTitle" class="draggable">Authorized Signatory</div>
                </div>
            </div>
        </main>
    </div>

<script>
window.jsPDF = window.jspdf.jsPDF;
let state = {};
let batchData = {
    jsonData: null,
    mapping: {
        recipientName: null,
        courseName: null,
        date: null
    }
};

const previewArea = document.getElementById('preview-area');
const styler = {
    panel: document.getElementById('element-styler'),
    label: document.getElementById('styler-label'),
    fontSize: document.getElementById('styler-fontSize'),
    fontFamily: document.getElementById('styler-fontFamily'),
    color: document.getElementById('styler-color'),
    fontWeight: document.getElementById('styler-fontWeight'),
    alignBtns: document.querySelectorAll('.align-btn'),
};
let selectedElementId = null;

// Paper size configurations in mm
const paperSizes = {
    a4: { width: 210, height: 297 },
    a3: { width: 297, height: 420 },
    letter: { width: 216, height: 279 }
};

const certificateTemplates = {
    internship: {
        certificateTitle: "Internship Completion Certificate",
        completionText: "has successfully completed an intensive internship program in",
        courseName: "Web Development, acquiring practical experience in modern development practices, team collaboration, and project delivery",
        signatureTitle: "Internship Coordinator"
    },
    achievement: {
        certificateTitle: "Certificate of Excellence",
        completionText: "is hereby recognized for outstanding achievement in",
        courseName: "Web Development and Programming, demonstrating exceptional skills and innovative problem-solving abilities",
        signatureTitle: "Director of Education"
    }
};

let customTextBoxCount = 0;

// Function to format date as "Month DD, YYYY"
function formatDate(date) {
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    // Handle string input
    if (typeof date === 'string') {
        date = new Date(date);
    }
    
    // Validate date
    if (!(date instanceof Date) || isNaN(date)) {
        return '';
    }

    const month = months[date.getMonth()];
    const day = date.getDate();
    const year = date.getFullYear();
    
    return `${month} ${day}, ${year}`;
}

function initializeState() {
    const today = new Date('2025-08-31');
    const formattedDate = formatDate(today);
    
    state = {
        orientation: 'landscape',
        paperSize: 'a4',
        backgroundImage: null,
        elements: {
            certificateTitle: { text: "Certificate of Achievement", x: 50, y: 15, width: 80, height: 15, style: { fontSize: 36, fontFamily: "'Playfair Display', serif", color: '#000000', fontWeight: 'bold', textAlign: 'center' } },
            completionText:   { text: "This is to certify that the above named individual has successfully completed", x: 50, y: 40, width: 70, height: 10, style: { fontSize: 18, fontFamily: "'Inter', sans-serif", color: '#333333', fontWeight: 'normal', textAlign: 'center' } },
            recipientName:    { text: "Name", x: 50, y: 30, width: 60, height: 12, style: { fontSize: 42, fontFamily: "'Playfair Display', serif", color: '#000000', fontWeight: 'bold', textAlign: 'center' } },
            courseName:       { text: "a comprehensive internship program in Web Development, demonstrating exceptional skills and dedication throughout the duration of the program", x: 50, y: 55, width: 75, height: 15, style: { fontSize: 20, fontFamily: "'Inter', sans-serif", color: '#333333', fontWeight: 'normal', textAlign: 'center' } },
            date:             { text: formattedDate, x: 50, y: 80, width: 40, height: 8, style: { fontSize: 18, fontFamily: "'Inter', sans-serif", color: '#555555', fontWeight: 'normal', textAlign: 'center' } },
            signature:        { text: "________________", x: 20, y: 88, width: 30, height: 5, style: { fontSize: 18, fontFamily: "'Inter', sans-serif", color: '#000000', fontWeight: 'normal', textAlign: 'left' } },
            signatureTitle:   { text: "Authorized Signatory", x: 20, y: 91, width: 30, height: 5, style: { fontSize: 16, fontFamily: "'Inter', sans-serif", color: '#333333', fontWeight: 'normal', textAlign: 'left' } },
        }
    };

    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('name');
    const title = urlParams.get('title');

    if (name) {
        document.getElementById('field-recipientName').value = decodeURIComponent(name);
    }
    if (title) {
        document.getElementById('field-courseName').value = decodeURIComponent(title);
    }

    document.getElementById('field-date').valueAsDate = new Date('2025-08-31');
    updateStateFromInput();
    renderPreview();
}

function updateStateFromInput() {
    document.querySelectorAll('#tab-content .form-input').forEach(input => {
        const field = input.dataset.field;
        if (state.elements[field]) {
            if (input.type === 'date') {
                state.elements[field].text = formatDate(new Date(input.value));
            } else {
                state.elements[field].text = input.value;
            }
        }
    });
    renderPreview();
}

function renderPreview() {
    const isLandscape = state.orientation === 'landscape';
    const container = document.getElementById('preview-container');
    const containerWidth = container.offsetWidth - 64; // padding
    const containerHeight = container.offsetHeight - 64; // padding

    // Get paper dimensions
    const paperDims = paperSizes[state.paperSize];
    const pdfWidth = isLandscape ? paperDims.height : paperDims.width;
    const pdfHeight = isLandscape ? paperDims.width : paperDims.height;
    const aspectRatio = pdfWidth / pdfHeight;
    let width, height;

    if (containerWidth / containerHeight > aspectRatio) {
        height = containerHeight;
        width = height * aspectRatio;
    } else {
        width = containerWidth;
        height = width / aspectRatio;
    }
    
    previewArea.style.width = `${width}px`;
    previewArea.style.height = `${height}px`;
    previewArea.style.backgroundImage = state.backgroundImage ? `url(${state.backgroundImage})` : 'none';

    for (const id in state.elements) {
        const elData = state.elements[id];
        const el = document.getElementById(`el-${id}`);
        if (el) {
            el.textContent = elData.text;
            el.style.fontSize = `${elData.style.fontSize}px`;
            el.style.fontFamily = elData.style.fontFamily;
            el.style.color = elData.style.color;
            el.style.fontWeight = elData.style.fontWeight;
            el.style.textAlign = elData.style.textAlign;

            el.style.position = 'absolute';
            el.style.top = `${elData.y}%`;
            el.style.left = `${elData.x}%`;
            
            if (elData.style.textAlign === 'center') {
                el.style.transform = 'translateX(-50%)';
            } else {
                el.style.transform = 'none';
            }
        }
    }
}

// Initialize both draggable and resizable
interact('.draggable')
    .draggable({
        listeners: {
            move(event) {
                const target = event.target;
                const id = target.dataset.id;
                if (!state.elements[id]) return;

                const elData = state.elements[id];
                const previewRect = previewArea.getBoundingClientRect();
                
                const dxPercent = (event.dx / previewRect.width) * 100;
                const dyPercent = (event.dy / previewRect.height) * 100;

                elData.x = Math.max(0, Math.min(100, (parseFloat(elData.x) || 0) + dxPercent));
                elData.y = Math.max(0, Math.min(100, (parseFloat(elData.y) || 0) + dyPercent));

                renderPreview();
            }
        }
    })
    .resizable({
        edges: { left: true, right: true, bottom: true, top: true },
        listeners: {
            move(event) {
                const target = event.target;
                const id = target.dataset.id;
                if (!state.elements[id]) return;

                const elData = state.elements[id];
                const previewRect = previewArea.getBoundingClientRect();

                // Update width and height in percentage
                if (!elData.width) elData.width = 20; // Default width if not set
                if (!elData.height) elData.height = 10; // Default height if not set

                const dxPercent = (event.deltaRect.width / previewRect.width) * 100;
                const dyPercent = (event.deltaRect.height / previewRect.height) * 100;

                elData.width = Math.max(10, Math.min(90, elData.width + dxPercent));
                elData.height = Math.max(5, Math.min(50, elData.height + dyPercent));

                // Update element style
                target.style.width = `${elData.width}%`;
                target.style.height = `${elData.height}%`;

                renderPreview();
            }
        }
    });

document.querySelectorAll('[data-tab]').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('[data-tab]').forEach(b => {
            b.classList.remove('active');
            b.classList.add('btn-secondary');
        });
        btn.classList.add('active');
        btn.classList.remove('btn-secondary');
        document.querySelectorAll('#tab-panels > div').forEach(p => p.classList.add('hidden'));
        document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
    });
});

document.querySelectorAll('.orientation-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.orientation-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.orientation = btn.id.includes('landscape') ? 'landscape' : 'portrait';
        renderPreview();
    });
});

document.querySelectorAll('#tab-content .form-input').forEach(input => {
    input.addEventListener('input', updateStateFromInput);
});

document.getElementById('bg-image').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            state.backgroundImage = e.target.result;
            renderPreview();
        };
        reader.readAsDataURL(file);
    }
});

previewArea.addEventListener('click', (event) => {
    const target = event.target.closest('.draggable');
    document.querySelectorAll('.draggable').forEach(d => d.classList.remove('selected'));
    if (target) {
        target.classList.add('selected');
        selectedElementId = target.dataset.id;
        styler.panel.classList.remove('hidden');
        updateStylerUI();
    } else {
        selectedElementId = null;
        styler.panel.classList.add('hidden');
    }
});

function updateStylerUI() {
    if (!selectedElementId) return;
    const style = state.elements[selectedElementId].style;
    const text = state.elements[selectedElementId].text;
    styler.label.textContent = `Styling: "${text.substring(0,20)}${text.length > 20 ? '...' : ''}"`;
    styler.fontSize.value = style.fontSize;
    styler.fontFamily.value = style.fontFamily;
    styler.color.value = style.color;
    styler.fontWeight.checked = style.fontWeight === 'bold';
    styler.alignBtns.forEach(b => b.classList.remove('active'));
    document.querySelector(`.align-btn[data-align="${style.textAlign}"]`)?.classList.add('active');
}

styler.fontSize.addEventListener('input', (e) => { if(selectedElementId) state.elements[selectedElementId].style.fontSize = e.target.value; renderPreview(); });
styler.fontFamily.addEventListener('change', (e) => { if(selectedElementId) state.elements[selectedElementId].style.fontFamily = e.target.value; renderPreview(); });
styler.color.addEventListener('input', (e) => { if(selectedElementId) state.elements[selectedElementId].style.color = e.target.value; renderPreview(); });
styler.fontWeight.addEventListener('change', (e) => { if(selectedElementId) state.elements[selectedElementId].style.fontWeight = e.target.checked ? 'bold' : 'normal'; renderPreview(); });
styler.alignBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        if(selectedElementId) {
            state.elements[selectedElementId].style.textAlign = btn.dataset.align;
            updateStylerUI();
            renderPreview();
        }
    });
});

async function generatePdf(data) {
    const doc = new jsPDF({ 
        orientation: state.orientation, 
        unit: 'mm', 
        format: state.paperSize 
    });
    const width = doc.internal.pageSize.getWidth();
    const height = doc.internal.pageSize.getHeight();
    
    // Calculate scaling factor based on A4 size
    const previewWidth = previewArea.offsetWidth;
    const scale = width / previewWidth;

    if (state.backgroundImage) {
        try {
            doc.addImage(state.backgroundImage, 'PNG', 0, 0, width, height);
        } catch(e) { console.error("Error adding background image:", e); }
    }

    for (const id in state.elements) {
        const elData = state.elements[id];
        const text = data[id] || elData.text;
        
        // Set font properties with corrected scaling
        doc.setFont(elData.style.fontFamily.split(',')[0].replace(/'/g, ''), elData.style.fontWeight === 'bold' ? 'bold' : 'normal');
        doc.setFontSize(elData.style.fontSize * 1.5); // Increased scaling factor
        doc.setTextColor(elData.style.color);

        // Calculate scaled positions
        const xPos = (elData.x / 100) * width;
        const yPos = (elData.y / 100) * height;

        // Get element dimensions if they exist
        const elementWidth = elData.width ? (elData.width / 100) * width : width * 0.8;

        // Add text with proper alignment and dimensions
        doc.text(text, xPos, yPos, { 
            align: elData.style.textAlign,
            baseline: 'top',
            maxWidth: elementWidth
        });
    }
    return doc;
}

document.getElementById('generate-pdf-btn').addEventListener('click', async () => {
    const doc = await generatePdf({
        recipientName: state.elements.recipientName.text,
        courseName: state.elements.courseName.text,
        date: state.elements.date.text,
        completionText: state.elements.completionText.text
    });
    doc.save(`${state.elements.recipientName.text.replace(/\s/g, '_')}_certificate.pdf`);
});

// Handle custom date visibility
document.getElementById('use-custom-date').addEventListener('change', function(e) {
    const customDateInput = document.getElementById('custom-date-input');
    if (e.target.checked) {
        customDateInput.classList.remove('hidden');
    } else {
        customDateInput.classList.add('hidden');
    }
});

document.getElementById('excel-file').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            
            batchData.jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            if (batchData.jsonData.length === 0) {
                alert('The selected Excel file is empty or could not be read.');
                return;
            }

            const headers = Object.keys(batchData.jsonData[0]);
            const mappingPanel = document.getElementById('column-mapping');
            const selectElements = document.querySelectorAll('.column-map-select');

            selectElements.forEach(select => {
                const field = select.dataset.field;
                select.innerHTML = '<option value="">-- Select Column --</option>';
                headers.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    select.appendChild(option);
                });

                // Auto-select common names
                const commonNames = {
                    recipientName: ['name', 'recipient', 'student'],
                    courseName: ['course', 'title', 'internship'],
                    date: ['date', 'issuedate', 'completiondate']
                };

                const matchingHeader = headers.find(h => commonNames[field].some(name => 
                    h.toLowerCase().includes(name))
                );
                if (matchingHeader) {
                    select.value = matchingHeader;
                    batchData.mapping[field] = matchingHeader;
                }
            });
            
            mappingPanel.classList.remove('hidden');
            document.getElementById('batch-generate-btn').disabled = false;

        } catch (error) {
            console.error('Error processing Excel file:', error);
            alert('There was an error processing the Excel file. Please ensure it is a valid .xlsx file.');
        }
    };
    reader.readAsArrayBuffer(file);
});

document.querySelectorAll('.column-map-select').forEach(select => {
    select.addEventListener('change', (event) => {
        const field = event.target.dataset.field;
        batchData.mapping[field] = event.target.value;
    });
});

document.getElementById('batch-generate-btn').addEventListener('click', async () => {
    if (!batchData.jsonData) {
        alert('Please select an Excel file first.');
        return;
    }

    if (!batchData.mapping.recipientName) {
        alert("Please map the column for 'Recipient\\'s Name'.");
        return;
    }

    const loader = document.getElementById('batch-loader');
    const btnText = document.getElementById('batch-btn-text');
    const progressContainer = document.getElementById('batch-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const generateBtn = document.getElementById('batch-generate-btn');

    loader.classList.remove('hidden');
    btnText.textContent = 'Processing...';
    generateBtn.disabled = true;
    progressContainer.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = '';

    try {
        const zip = new JSZip();
        const total = batchData.jsonData.length;

        for (let i = 0; i < total; i++) {
            const row = batchData.jsonData[i];
            const name = row[batchData.mapping.recipientName] || 'Unnamed';
            
            // Use the same content as the single certificate, only change the recipient name
            const pdfData = {};
            for (const [key, element] of Object.entries(state.elements)) {
                pdfData[key] = key === 'recipientName' ? name : element.text;
            }

            const doc = await generatePdf(pdfData);
            zip.file(`${name.replace(/\s/g, '_')}.pdf`, await doc.output('blob'));

            const percentComplete = ((i + 1) / total) * 100;
            progressBar.style.width = `${percentComplete}%`;
            progressText.textContent = `Generating certificate ${i + 1} of ${total}...`;
        }

        progressText.textContent = 'Compressing files into a zip...';
        const content = await zip.generateAsync({ type: 'blob' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = 'certificates.zip';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        progressText.textContent = 'Done!';

    } catch (error) {
        console.error('Error during batch generation:', error);
        alert('An error occurred during batch generation. Please check the console.');
        progressText.textContent = 'An error occurred.';
    } finally {
        loader.classList.add('hidden');
        btnText.textContent = 'Generate Certificates';
        generateBtn.disabled = false;
        setTimeout(() => {
            progressContainer.classList.add('hidden');
        }, 5000);
    }
});

// Handle template selection
document.getElementById('template-selector').addEventListener('change', function(e) {
    const template = certificateTemplates[e.target.value];
    if (template) {
        document.getElementById('field-certificateTitle').value = template.certificateTitle;
        document.getElementById('field-completionText').value = template.completionText;
        document.getElementById('field-courseName').value = template.courseName;
        document.getElementById('field-signatureTitle').value = template.signatureTitle;
        updateStateFromInput();
    }
});

// Handle adding custom text boxes
document.getElementById('add-text-box').addEventListener('click', function() {
    const customBoxId = `custom-${customTextBoxCount++}`;
    const container = document.getElementById('custom-text-boxes');
    
    const boxDiv = document.createElement('div');
    boxDiv.className = 'custom-text-box mt-3 space-y-2';
    boxDiv.innerHTML = `
        <div class="flex justify-between items-center">
            <input type="text" placeholder="Text Box Label" 
                   class="form-input" style="width: calc(100% - 40px);"
                   data-custom-label="${customBoxId}">
            <button class="btn delete-text-box" data-box-id="${customBoxId}">
                <i class="fas fa-trash" style="color: #ef4444;"></i>
            </button>
        </div>
        <textarea class="form-input" data-custom-content="${customBoxId}" 
                  style="min-height: 60px;" placeholder="Enter text content"></textarea>
    `;
    
    container.appendChild(boxDiv);
    
    // Add the custom text box to the state and preview
    state.elements[customBoxId] = {
        text: "",
        x: 50,
        y: 70,
        style: {
            fontSize: 18,
            fontFamily: "'Inter', sans-serif",
            color: '#333333',
            fontWeight: 'normal',
            textAlign: 'center'
        }
    };
    
    // Add element to preview area
    const previewEl = document.createElement('div');
    previewEl.id = `el-${customBoxId}`;
    previewEl.dataset.id = customBoxId;
    previewEl.className = 'draggable';
    previewArea.appendChild(previewEl);
    
    // Update preview when content changes
    const contentInput = boxDiv.querySelector(`[data-custom-content="${customBoxId}"]`);
    contentInput.addEventListener('input', function() {
        state.elements[customBoxId].text = this.value;
        renderPreview();
    });
    
    // Handle deletion
    boxDiv.querySelector('.delete-text-box').addEventListener('click', function() {
        const boxId = this.dataset.boxId;
        // Remove from DOM
        boxDiv.remove();
        // Remove preview element
        document.getElementById(`el-${boxId}`).remove();
        // Remove from state
        delete state.elements[boxId];
    });
    
    renderPreview();
});

// Handle paper size changes
document.getElementById('paper-size').addEventListener('change', function(e) {
    state.paperSize = e.target.value;
    const paperSizeText = e.target.options[e.target.selectedIndex].text;
    previewArea.setAttribute('data-paper-size', paperSizeText);
    renderPreview();
});

window.addEventListener('resize', renderPreview);
initializeState();

// Set initial paper size label
const paperSizeSelect = document.getElementById('paper-size');
const initialPaperSizeText = paperSizeSelect.options[paperSizeSelect.selectedIndex].text;
previewArea.setAttribute('data-paper-size', initialPaperSizeText);
</script>
</body>
</html>