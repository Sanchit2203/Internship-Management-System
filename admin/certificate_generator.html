<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Generator</title>
    
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.10.11/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #4a5568;
            --secondary-color: #f7fafc;
            --text-color: #2d3748;
            --bg-color: #edf2f7;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .preview-area {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
            background-color: white;
        }

        .draggable {
            touch-action: none;
            user-select: none;
            position: absolute !important;
            box-sizing: border-box;
            border: 2px dashed transparent;
            transition: border-color 0.2s;
            padding: 5px;
            cursor: move;
        }

        .draggable.selected {
            border-color: var(--primary-color);
            z-index: 1000;
        }

        .tab-btn {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #718096;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.2);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .orientation-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2d3748;
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .controls-panel {
             background: white; 
             padding: 2rem; 
             border-radius: 8px; 
             box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .space-y-4 > *:not(:last-child) {
            margin-bottom: 1rem;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><img src="../image.png" alt="CareerConnect Logo" class="navbar-logo"></div>
        <ul class="nav-links">
            <li><a href="admin_panel.html">Admin Home</a></li>
        </ul>
    </nav>

    <div class="container" style="max-width: 1400px; margin: auto; padding: 2rem;">
        <main style="display: grid; grid-template-columns: 400px 1fr; gap: 2rem;">
            <div class="controls-panel">
                <div class="tabs" style="display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem;">
                    <button class="tab-btn active" data-tab="content">Content</button>
                    <button class="tab-btn" data-tab="customize">Customize</button>
                    <button class="tab-btn" data-tab="batch">Batch</button>
                </div>

                <div id="tab-panels">
                    <div id="tab-content" class="space-y-4">
                        <h3 style="font-size: 1.25rem; font-weight: 600;">Certificate Content</h3>
                        <div>
                            <label for="field-recipientName" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Recipient's Name</label>
                            <input type="text" id="field-recipientName" data-field="recipientName" class="form-input" value="Jane Doe">
                        </div>
                        <div>
                            <label for="field-courseName" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Course/Internship Title</label>
                            <input type="text" id="field-courseName" data-field="courseName" class="form-input" value="Web Development Masterclass">
                        </div>
                        <div>
                            <label for="field-completionText" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Completion Text</label>
                            <input type="text" id="field-completionText" data-field="completionText" class="form-input" value="has successfully completed">
                        </div>
                        <div>
                            <label for="field-date" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Date of Issue</label>
                            <input type="date" id="field-date" data-field="date" class="form-input">
                        </div>
                    </div>

                    <div id="tab-customize" class="hidden space-y-4">
                        <h3 style="font-size: 1.25rem; font-weight: 600;">Layout & Style</h3>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Orientation</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <button id="orientation-landscape" class="orientation-btn btn active">Landscape</button>
                                <button id="orientation-portrait" class="orientation-btn btn">Portrait</button>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Background Image</label>
                            <input type="file" id="bg-image" accept="image/*" class="form-input">
                        </div>
                        <div id="element-styler" class="hidden" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                            <h4 id="styler-label" style="font-weight: 600; margin-bottom: 1rem;"></h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label>Font Size (px)</label>
                                    <input type="number" id="styler-fontSize" class="form-input">
                                </div>
                                <div>
                                    <label>Font Family</label>
                                    <select id="styler-fontFamily" class="form-select">
                                        <option value="'Playfair Display', serif">Serif</option>
                                        <option value="'Inter', sans-serif">Sans-serif</option>
                                        <option value="'Roboto Mono', monospace">Monospace</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Color</label>
                                    <input type="color" id="styler-color" class="form-input" style="padding: 5px;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="styler-fontWeight" style="width: 20px; height: 20px;">
                                    <label>Bold</label>
                                </div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem;">Alignment</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="align-btn btn" data-align="left"><i class="fas fa-align-left"></i></button>
                                    <button class="align-btn btn" data-align="center"><i class="fas fa-align-center"></i></button>
                                    <button class="align-btn btn" data-align="right"><i class="fas fa-align-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-batch" class="hidden space-y-4">
                        <h3 style="font-size: 1.25rem; font-weight: 600;">Batch Generation</h3>
                        <p style="font-size: 0.9rem; color: #718096;">Upload an Excel (.xlsx) file with columns: 'Name', 'Title', 'Date'.</p>
                        <input type="file" id="excel-file" accept=".xlsx" class="form-input">
                        <button id="batch-generate-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                            <span id="batch-btn-text">Generate from Excel</span>
                            <div id="batch-loader" class="loader hidden" style="margin-left: 10px;"></div>
                        </button>
                    </div>
                </div>

                <div style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                     <button id="generate-pdf-btn" class="btn btn-primary" style="width: 100%; font-size: 1.1rem;">
                        <i class="fas fa-file-pdf" style="margin-right: 0.5rem;"></i>
                        Generate Single PDF
                     </button>
                </div>
            </div>

            <div id="preview-container" style="background: var(--secondary-color); padding: 2rem; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <div id="preview-area" class="preview-area">
                    <div id="el-certificateTitle" data-id="certificateTitle" class="draggable">Certificate of Completion</div>
                    <div id="el-completionText" data-id="completionText" class="draggable">has successfully completed</div>
                    <div id="el-recipientName" data-id="recipientName" class="draggable">Jane Doe</div>
                    <div id="el-courseName" data-id="courseName" class="draggable">Web Development Masterclass</div>
                    <div id="el-date" data-id="date" class="draggable">July 28, 2025</div>
                    <div id="el-signature" data-id="signature" class="draggable">_________________________</div>
                    <div id="el-signatureTitle" data-id="signatureTitle" class="draggable">Authorized Signatory</div>
                </div>
            </div>
        </main>
    </div>

<script>
window.jsPDF = window.jspdf.jsPDF;
let state = {};

const previewArea = document.getElementById('preview-area');
const styler = {
    panel: document.getElementById('element-styler'),
    label: document.getElementById('styler-label'),
    fontSize: document.getElementById('styler-fontSize'),
    fontFamily: document.getElementById('styler-fontFamily'),
    color: document.getElementById('styler-color'),
    fontWeight: document.getElementById('styler-fontWeight'),
    alignBtns: document.querySelectorAll('.align-btn'),
};
let selectedElementId = null;

function initializeState() {
    state = {
        orientation: 'landscape',
        backgroundImage: null,
        elements: {
            certificateTitle: { text: "Certificate of Completion", x: 50, y: 20, style: { fontSize: 30, fontFamily: "'Playfair Display', serif", color: '#000000', fontWeight: 'bold', textAlign: 'center' } },
            completionText:   { text: "proudly presented to", x: 50, y: 40, style: { fontSize: 20, fontFamily: "'Inter', sans-serif", color: '#333333', fontWeight: 'normal', textAlign: 'center' } },
            recipientName:    { text: "Name", x: 50, y: 50, style: { fontSize: 40, fontFamily: "'Playfair Display', serif", color: '#000000', fontWeight: 'bold', textAlign: 'center' } },
            courseName:       { text: "for successfully completing the Web Development Masterclass", x: 50, y: 65, style: { fontSize: 22, fontFamily: "'Inter', sans-serif", color: '#333333', fontWeight: 'normal', textAlign: 'center' } },
            date:             { text: "Issued on", x: 50, y: 80, style: { fontSize: 18, fontFamily: "'Inter', sans-serif", color: '#555555', fontWeight: 'normal', textAlign: 'center' } },
            signature:        { text: "_________________________", x: 20, y: 88, style: { fontSize: 18, fontFamily: "'Inter', sans-serif", color: '#000000', fontWeight: 'normal', textAlign: 'left' } },
            signatureTitle:   { text: "Authorized Signatory", x: 20, y: 92, style: { fontSize: 16, fontFamily: "'Inter', sans-serif", color: '#333333', fontWeight: 'normal', textAlign: 'left' } },
        }
    };

    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('name');
    const title = urlParams.get('title');

    if (name) {
        document.getElementById('field-recipientName').value = decodeURIComponent(name);
    }
    if (title) {
        document.getElementById('field-courseName').value = decodeURIComponent(title);
    }

    document.getElementById('field-date').valueAsDate = new Date();
    updateStateFromInput();
    renderPreview();
}

function updateStateFromInput() {
    document.querySelectorAll('#tab-content .form-input').forEach(input => {
        const field = input.dataset.field;
        if (state.elements[field]) {
            state.elements[field].text = input.value;
        }
    });
    renderPreview();
}

function renderPreview() {
    const isLandscape = state.orientation === 'landscape';
    const container = document.getElementById('preview-container');
    const containerWidth = container.offsetWidth - 64; // padding
    const containerHeight = container.offsetHeight - 64; // padding

    const aspectRatio = isLandscape ? 842 / 595 : 595 / 842;
    let width, height;

    if (containerWidth / containerHeight > aspectRatio) {
        height = containerHeight;
        width = height * aspectRatio;
    } else {
        width = containerWidth;
        height = width / aspectRatio;
    }
    
    previewArea.style.width = `${width}px`;
    previewArea.style.height = `${height}px`;
    previewArea.style.backgroundImage = state.backgroundImage ? `url(${state.backgroundImage})` : 'none';

    for (const id in state.elements) {
        const elData = state.elements[id];
        const el = document.getElementById(`el-${id}`);
        if (el) {
            el.textContent = elData.text;
            el.style.fontSize = `${elData.style.fontSize}px`;
            el.style.fontFamily = elData.style.fontFamily;
            el.style.color = elData.style.color;
            el.style.fontWeight = elData.style.fontWeight;
            el.style.textAlign = elData.style.textAlign;

            el.style.position = 'absolute';
            el.style.top = `${elData.y}%`;
            el.style.left = `${elData.x}%`;
            
            if (elData.style.textAlign === 'center') {
                el.style.transform = 'translateX(-50%)';
            } else {
                el.style.transform = 'none';
            }
        }
    }
}

interact('.draggable').draggable({
    listeners: {
        move(event) {
            const target = event.target;
            const id = target.dataset.id;
            if (!state.elements[id]) return;

            const elData = state.elements[id];
            const previewRect = previewArea.getBoundingClientRect();
            
            const dxPercent = (event.dx / previewRect.width) * 100;
            const dyPercent = (event.dy / previewRect.height) * 100;

            elData.x = Math.max(0, Math.min(100, (parseFloat(elData.x) || 0) + dxPercent));
            elData.y = Math.max(0, Math.min(100, (parseFloat(elData.y) || 0) + dyPercent));

            renderPreview();
        }
    }
});

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('#tab-panels > div').forEach(p => p.classList.add('hidden'));
        document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
    });
});

document.querySelectorAll('.orientation-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.orientation-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.orientation = btn.id.includes('landscape') ? 'landscape' : 'portrait';
        renderPreview();
    });
});

document.querySelectorAll('#tab-content .form-input').forEach(input => {
    input.addEventListener('input', updateStateFromInput);
});

document.getElementById('bg-image').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            state.backgroundImage = e.target.result;
            renderPreview();
        };
        reader.readAsDataURL(file);
    }
});

previewArea.addEventListener('click', (event) => {
    const target = event.target.closest('.draggable');
    document.querySelectorAll('.draggable').forEach(d => d.classList.remove('selected'));
    if (target) {
        target.classList.add('selected');
        selectedElementId = target.dataset.id;
        styler.panel.classList.remove('hidden');
        updateStylerUI();
    } else {
        selectedElementId = null;
        styler.panel.classList.add('hidden');
    }
});

function updateStylerUI() {
    if (!selectedElementId) return;
    const style = state.elements[selectedElementId].style;
    const text = state.elements[selectedElementId].text;
    styler.label.textContent = `Styling: "${text.substring(0,20)}${text.length > 20 ? '...' : ''}"`;
    styler.fontSize.value = style.fontSize;
    styler.fontFamily.value = style.fontFamily;
    styler.color.value = style.color;
    styler.fontWeight.checked = style.fontWeight === 'bold';
    styler.alignBtns.forEach(b => b.classList.remove('active'));
    document.querySelector(`.align-btn[data-align="${style.textAlign}"]`)?.classList.add('active');
}

styler.fontSize.addEventListener('input', (e) => { if(selectedElementId) state.elements[selectedElementId].style.fontSize = e.target.value; renderPreview(); });
styler.fontFamily.addEventListener('change', (e) => { if(selectedElementId) state.elements[selectedElementId].style.fontFamily = e.target.value; renderPreview(); });
styler.color.addEventListener('input', (e) => { if(selectedElementId) state.elements[selectedElementId].style.color = e.target.value; renderPreview(); });
styler.fontWeight.addEventListener('change', (e) => { if(selectedElementId) state.elements[selectedElementId].style.fontWeight = e.target.checked ? 'bold' : 'normal'; renderPreview(); });
styler.alignBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        if(selectedElementId) {
            state.elements[selectedElementId].style.textAlign = btn.dataset.align;
            updateStylerUI();
            renderPreview();
        }
    });
});

async function generatePdf(data) {
    const doc = new jsPDF({ orientation: state.orientation, unit: 'pt', format: 'a4' });
    const width = doc.internal.pageSize.getWidth();
    const height = doc.internal.pageSize.getHeight();

    if (state.backgroundImage) {
        try {
            doc.addImage(state.backgroundImage, 'PNG', 0, 0, width, height);
        } catch(e) { console.error("Error adding background image:", e); }
    }

    for (const id in state.elements) {
        const elData = state.elements[id];
        const text = data[id] || elData.text;
        
        doc.setFont(elData.style.fontFamily.split(',')[0].replace(/'/g, ''), elData.style.fontWeight === 'bold' ? 'bold' : 'normal');
        doc.setFontSize(elData.style.fontSize);
        doc.setTextColor(elData.style.color);

        const xPos = (elData.x / 100) * width;
        const yPos = (elData.y / 100) * height;

        doc.text(text, xPos, yPos, { align: elData.style.textAlign, baseline: 'top' });
    }
    return doc;
}

document.getElementById('generate-pdf-btn').addEventListener('click', async () => {
    const doc = await generatePdf({
        recipientName: state.elements.recipientName.text,
        courseName: state.elements.courseName.text,
        date: state.elements.date.text,
        completionText: state.elements.completionText.text
    });
    doc.save(`${state.elements.recipientName.text.replace(/\s/g, '_')}_certificate.pdf`);
});

document.getElementById('batch-generate-btn').addEventListener('click', async () => {
    const file = document.getElementById('excel-file').files[0];
    if (!file) { alert('Please select an Excel file.'); return; }

    const loader = document.getElementById('batch-loader');
    const btnText = document.getElementById('batch-btn-text');
    loader.classList.remove('hidden');
    btnText.textContent = 'Processing...';

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            const zip = new JSZip();
            for (const row of json) {
                const name = row.Name || row.name || 'Unnamed';
                const doc = await generatePdf({
                    recipientName: name,
                    courseName: row.Title || row.title || state.elements.courseName.text,
                    date: row.Date || row.date || state.elements.date.text,
                    completionText: row.CompletionText || row.completiontext || state.elements.completionText.text
                });
                zip.file(`${name.replace(/\s/g, '_')}.pdf`, await doc.output('blob'));
            }

            const content = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = 'certificates.zip';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error('Error during batch generation:', error);
            alert('An error occurred during batch generation. Please check the console.');
        } finally {
            loader.classList.add('hidden');
            btnText.textContent = 'Generate from Excel';
        }
    };
    reader.readAsArrayBuffer(file);
});

window.addEventListener('resize', renderPreview);
initializeState();
</script>
</body>
</html>